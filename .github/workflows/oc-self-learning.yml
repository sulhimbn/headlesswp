name: oc - self-learning orchestrator

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

env:
  IFLOW_MODEL: iflowcn/qwen3-coder-plus
  POLICY_DIR: .iflow
  DATASET_PREFIX: iflow-dataset
  SCORE_THRESHOLD_AUTO_MERGE: '0.88' # contoh threshold (0-1)

jobs:

  opencode:
    name: opencode - main agent runner
    runs-on: ubuntu-latest
    timeout-minutes: 40
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'issue_comment' ||
      github.event_name == 'push'

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      
    env:
      GH_TOKEN: ${{ github.token }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
      
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH
      - name: Run OpenCode1
        id: run_agent1
        timeout-minutes: 20
        run: |
          opencode run "$(cat <<'PROMPT'
          Anda adalah Orchestrator utama untuk repositori Headless WordPress.
          Repositori: https://github.com/sulhimbn/headlesswp
          
          Tugas Anda:
          
          1. **Analisis Mendalam Repositori**
             - Analisis seluruh struktur kode, arsitektur, modul, API, workflow, konfigurasi, dan folder.
             - Analisis commit history, PR, issue, discussion, dan logs GitHub Actions.
             - Identifikasi inkonsistensi, error, smell code, technical debt, arsitektur yang kurang optimal, dan potensi otomatisasi.
          
          2. **Manajemen Project GitHub**
             - Buat atau update **Projects** pada repositori.
             - Atur kolom, status, metadata, prioritas, dan kategori task.
             - Sinkronkan PR dan issue otomatis ke project yang relevan.
          
          3. **Roadmap & Prioritization**
             - Buat/update roadmap jangka pendek, menengah, dan panjang.
             - Prioritaskan tasks berdasarkan dampak teknis, dependensi, resiko, dan urgensi.
          
          4. **Task Generation**
             - Hasilkan daftar tugas granular dan actionable.
             - Formatkan dalam bentuk issue/PR atau patch jika diperlukan.
             - Sertakan konteks teknis dan alasan prioritas.
          
          5. **Output**
             - Output HARUS berupa instruksi yang valid untuk GitHub atau patch unified diff bila melakukan perubahan kode.
             - Tidak menambahkan komentar atau penjelasan di luar struktur yang diminta.
          
          Jalankan seluruh tugas dengan sangat hati-hati, mendalam, dan konsisten.
          PROMPT
          )"
            --model iflowcn/glm-4.6 \
            --share false \
      - name: Run OpenCode2
        id: run_agent2
        timeout-minutes: 20
        run: |
          opencode run Anda adalah agen orkestrator, lakukan tugas di file markdown todo dan beri ceklist tugas yang telah selesai, kemudian commit dan push ke branch dev. \
            --model iflowcn/qwen3-coder-plus \
            --share false \
