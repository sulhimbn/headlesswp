name: oc - self-learning orchestrator

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read

# global lock: only 1 instance of this workflow running across events
concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

env:
  IFLOW_MODEL: iflowcn/qwen3-coder-plus
  POLICY_DIR: .iflow
  DATASET_PREFIX: iflow-dataset
  SCORE_THRESHOLD_AUTO_MERGE: '0.88' # contoh threshold (0-1)

jobs:

  opencode:
    name: opencode - main agent runner
    runs-on: ubuntu-latest
    timeout-minutes: 40
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'issue_comment' ||
      github.event_name == 'push'

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write

    steps:
      - name: Short debounce to group bursts
        run: sleep 6

      - name: Harden runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Collect context: PRs, Issues, Workflow metadata
        id: collect_meta
        run: |
          gh pr list --state open --json number,title,url,author,labels,headRefName,mergeable > pr_meta.json || true
          gh issue list --state open --json number,title,url,author,labels > issue_meta.json || true
          gh api repos/${GITHUB_REPOSITORY}/actions/runs --paginate > runs_list.json || true
          echo "collected"

      - name: Build dataset record for this run
        id: build_dataset
        run: |
          ts=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "{\"run_id\":\"${GITHUB_RUN_ID}\",\"run_ts\":\"$ts\",\"event\":\"${GITHUB_EVENT_NAME}\"}" > run_metadata.json
          jq -s '.[0] * {pr_meta: .[1], issue_meta: .[2]}' run_metadata.json pr_meta.json issue_meta.json > ${DATASET_PREFIX}_${ts}.json || true
          echo "dataset_file=${DATASET_PREFIX}_${ts}.json" >> $GITHUB_OUTPUT

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Run OpenCode agent with extended prompt (self-learning aware)
        id: run_agent
        timeout-minutes: 20
        run: |
          opencode run --model ${IFLOW_MODEL} \
            --file ./pr_meta.json \
            --file ./issue_meta.json \
            --file ./run_metadata.json \
            --file ./quality_summary.json \
            --share false \
            "$(cat <<'PROMPT'
You are iFlow Level3 orchestrator.
Tasks:
1) Prioritize tasks: issues > open PRs > maintenance.
2) For a chosen task, generate:
   - actions to fix (commands + files to change).
   - required checks (lint/test).
   - a 'risk' score [0-1] and 'explain' text.
3) If proposing changes to repo configs, write them to /.iflow/ as files and create a new branch + PR. NEVER push directly to main or modify workflow files.
4) Produce a JSON report with keys:
   { "task": "...", "actions": [...], "risk": 0.xx, "score": 0.xx, "explain": "..." }
5) Use past-feedback (labels iflow/ok, iflow/bad, comments +1/-1) to estimate expected success.
PROMPT
)" > agent_output.json || true
          cat agent_output.json || true

      - name: Save dataset artifact (for offline training/eval)
        uses: actions/upload-artifact@v4
        with:
          name: iflow-dataset-${{ github.run_id }}
          path: |
            ${DATASET_PREFIX}_*.json
            agent_output.json
            run_metadata.json
            quality_summary.json
            pr_meta.json
            issue_meta.json

      - name: Create branch + PR if agent proposed .iflow changes
        if: ${{ always() }}
        run: |
          # agent_output.json must include an entry 'propose_files' when it wants to change prompts/policies
          jq -r '.propose_files // empty' agent_output.json > /dev/null 2>&1 || exit 0
          PROPOSED=$(jq -r '.propose_files | keys[]' agent_output.json 2>/dev/null || true)
          if [ -z "$PROPOSED" ]; then
            echo "No policy/prompt updates proposed."
            exit 0
          fi
          BR="iflow/policy-update-${GITHUB_RUN_ID}"
          git config user.name "iflow-bot"
          git config user.email "noreply+iflow@users.noreply.github.com"
          git fetch origin main
          git switch -c $BR
          # write files
          for k in ${PROPOSED}; do
            content=$(jq -r ".propose_files[\"$k\"]" agent_output.json)
            mkdir -p $(dirname $k)
            echo "$content" > $k
            git add $k
          done
          git commit -m "iFlow: propose policy/prompt updates (run ${GITHUB_RUN_ID})" || true
          git push -u origin $BR
          gh pr create --title "iFlow: propose policy/prompt updates" --body "Autogenerated policy/prompt updates from iFlow run ${GITHUB_RUN_ID}. Please review." --base main || true

      - name: PR Evaluation & Auto-merge safe PRs
        run: |
          # compute PR quality scores (basic heuristic)
          PRS=$(jq -r '.[]?.number' pr_meta.json || true)
          for pr in $PRS; do
            echo "Evaluating PR #$pr"
            # gather CI status
            state=$(gh pr view $pr --json mergeable,reviewDecision,commits -q '.mergeable' 2>/dev/null || echo "UNKNOWN")
            # request agent score (if agent_output contains per-pr)
            prscore=$(jq -r --arg pr "$pr" '.pr_scores[$pr] // empty' agent_output.json 2>/dev/null || echo "")
            # if mergeable & score high & label present -> auto merge
            labels=$(gh pr view $pr --json labels -q '.labels[].name' 2>/dev/null || true)
            echo "prscore=$prscore; mergeable=$state; labels=$labels"
            if [[ "$labels" =~ "iflow/auto-merge" ]] && [[ "$state" == "MERGEABLE" ]] && (( $(echo "$prscore >= ${SCORE_THRESHOLD_AUTO_MERGE}" | bc -l) )); then
              echo "Auto-merging PR #$pr"
              gh pr merge $pr --auto --squash || true
            fi
          done

      - name: Post run: annotate metrics & ask for feedback
        run: |
          # create summary comment on triggered issue/PR if any
          if [ "${GITHUB_EVENT_NAME}" = "issue_comment" ]; then
            echo "Posting summary comment..."
            gh issue comment ${GITHUB_EVENT_NUMBER} --body "iFlow ran. See artifact: iflow-dataset-${GITHUB_RUN_ID}.zip. To provide feedback, reply with +1 or -1, or add label iflow/ok or iflow/bad." || true
          fi

  watchdog_unlock:
    name: watchdog - detect stuck runs and cancel old runs
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: List recent runs and cancel old running ones
        run: |
          runs=$(gh api repos/${GITHUB_REPOSITORY}/actions/runs --paginate -q '.workflow_runs[] | select(.name=="opencode level3 - self-learning orchestrator") | select(.status=="in_progress") | .id' || true)
          for id in $runs; do
            # skip current run id
            if [ "$id" = "${GITHUB_RUN_ID}" ]; then
              continue
            fi
            echo "Cancelling stuck run $id"
            gh api -X POST repos/${GITHUB_REPOSITORY}/actions/runs/$id/cancel || true
          done

  evaluate_model:
    name: offline-eval - compute metrics & create report
    runs-on: ubuntu-latest
    needs: opencode
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download latest artifacts
        uses: actions/download-artifact@v4
        with:
          name: iflow-dataset-${{ github.run_id }}
          path: artifacts || true

      - name: Compute simple metrics & upload report
        run: |
          # This is a placeholder: you can replace with real analytics code
          echo '{"run":"'${GITHUB_RUN_ID}'","notes":"placeholder metrics"}' > eval_report_${GITHUB_RUN_ID}.json
          gh api repos/${GITHUB_REPOSITORY}/actions/artifacts --silent || true

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: iflow-eval-${{ github.run_id }}
          path: eval_report_${GITHUB_RUN_ID}.json

