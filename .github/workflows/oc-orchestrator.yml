name: OC Orchestrator

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  issues: read
  actions: read

concurrency:
  group: ${{ github.workflow }}-global
  cancel-in-progress: false

jobs:
  opencode:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      actions: write
      repository-projects: write

    env:
      GH_TOKEN: ${{ github.token }}
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}

    steps:
      - name: Harden runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Collect metadata from open PRs and Issues
        id: collect_meta
        run: |
          echo "Collecting PRs and Issues metadata..."
          gh pr list --state open --json number,title,url,author,labels,headRefName,mergeable > pr_meta.json
          gh issue list --state open --json number,title,url,author,labels > issue_meta.json
          echo "✅ Saved metadata to pr_meta.json and issue_meta.json"

      - name: Collect GitHub CLI / Runner environment metadata
        id: collect_env
        run: |
          echo "Collecting GH CLI and runner environment metadata..."
          gh --version > gh_cli_version.txt || true
          gh auth status --show-token 2>/dev/null || gh auth status > gh_auth_status.txt || true
          uname -a > runner_uname.txt || true
          echo "GITHUB_REPOSITORY=${GITHUB_REPOSITORY}" > gh_action_env.txt
          echo "GITHUB_REF=${GITHUB_REF}" >> gh_action_env.txt
          echo "GITHUB_SHA=${GITHUB_SHA}" >> gh_action_env.txt
          cat > metadata_sources.json
          echo "✅ Saved environment metadata files."

      - name: Summarize collected metadata
        run: |
          echo "=== Open Pull Requests ==="
          cat pr_meta.json | jq . || true
          echo "=== Open Issues ==="
          cat issue_meta.json | jq . || true
          echo "=== GH CLI Version ==="
          cat gh_cli_version.txt || true
          echo "=== Runner Info ==="
          cat runner_uname.txt || true
          echo "=== GH Env ==="
          cat gh_action_env.txt || true

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.opencode/bin" >> $GITHUB_PATH

      - name: Run OpenCode agent
        run: |
          opencode run "Anda adalah Project Orchestrator untuk pengembangan WordPress Headless mitrabantennews.com, Anda mempunyai akses gh, analisis seluruh metadata (Project, PR, Issue, repo, file), tentukan prioritas pekerjaan, identifikasi perubahan yang diperlukan, dan hasilkan hanya unified diff patch yang valid tanpa penjelasan lain, untuk memperbaiki struktur, fungsi, bug, konsistensi API, arsitektur headless, dan kebutuhan teknis repositori secara otomatis, commit dan push perubahan ke branch Dev." \
            --model iflowcn/glm-4.6 \
            --file ./pr_meta.json \
            --file ./issue_meta.json \
            --file ./gh_cli_version.txt \
            --file ./gh_action_env.txt \
            --file ./metadata_sources.json \
            --share false

